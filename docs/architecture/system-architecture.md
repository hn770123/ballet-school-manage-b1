# システム構成と技術スタック

**作成日**: 2024年12月
**更新日**: 2025年12月

---

## 4. システム構成

### 4.1 技術基盤

**Cloudflare エッジコンピューティング + LINE Platform**

|コンポーネント           |役割                    |
|------------------|----------------------|
|Cloudflare Workers|API・Webアプリケーションのホスティング|
|Cloudflare D1     |SQLiteベースのデータベース      |
|Workers AI        |多言語翻訳、コンテキスト解釈        |
|LINE公式アカウント|保護者との主要コミュニケーションチャネル|
|LIFF (LINE Front-end Framework)|LINE内で動作するWebアプリケーション|
|LINE Messaging API|メッセージ送受信（Reply中心）|
|LINE Login|保護者の認証・識別|

### 4.2 LINE Platform 構成

#### LINE公式アカウント

保護者との主要な接点となるLINE公式アカウントを開設。

**役割**:
- 保護者がLINEアプリ内から直接システムにアクセス
- リッチメニューによるナビゲーション
- Webhookによるメッセージ受信と自動応答

**機能**:
- 友だち追加時の初期登録案内
- キーワード応答による情報取得
- LIFFアプリへの導線

#### LIFF（LINE Front-end Framework）

LINE内で動作するWebアプリケーションとして実装。

**メリット**:
- LINEアプリ内でシームレスに動作
- LINE Loginによる自動認証（ユーザー識別）
- ネイティブアプリのインストール不要
- プッシュ通知なしでもユーザーがプル型で情報取得可能

**LIFFアプリ構成**:

| アプリ名 | 画面サイズ | 用途 |
|---------|-----------|------|
| メイン | Full | 児童情報登録、準備物一覧、ステータス更新 |
| タスク詳細 | Tall | 個別タスクの詳細表示・更新 |
| クイック確認 | Compact | ステータスのクイック確認 |

### 4.3 アーキテクチャ

```
[保護者]
    │
    ├─[LINE公式アカウント]─────────────────────────┐
    │       │                                      │
    │       ├─[リッチメニュー]→[LIFFアプリ]        │
    │       │                     │                │
    │       ├─[メッセージ送信]→[Webhook]           │
    │       │                     │                │
    │       └─[キーワード応答]←[Reply Token]       │
    │                             │                │
    └─[Webブラウザ（管理者）]     │                │
              │                   │                │
              ↓                   ↓                │
        [Cloudflare Workers]←────┘                │
              │                                    │
    ┌─────────┼─────────┬─────────┐               │
    │         │         │         │               │
    ↓         ↓         ↓         ↓               │
┌───────┐┌───────┐┌─────────┐┌──────────┐        │
│ D1 DB ││Workers││  LINE   ││   LINE   │        │
│(データ)││  AI   ││Messaging││  Login   │←───────┘
│       ││(翻訳) ││   API   ││  (認証)  │
└───────┘└───────┘└─────────┘└──────────┘
```

### 4.4 データフロー

#### 保護者の操作フロー（プル型）

**最初の保護者（新規登録）**:

1. 保護者（例: 母）がLINE公式アカウントを友だち追加
2. リッチメニューからLIFFアプリを起動
3. LINE Loginで自動認証（LINE User ID取得）
4. 初回登録画面で「新規登録」を選択
5. 児童情報を登録（名前、教室、自分との関係）
6. システムがアクセスコードを発行（例: `HNK-7842`）
7. `line_accounts` に LINEアカウント情報を保存
8. `students` に生徒情報を保存
9. `line_student_access` に紐づけを保存（is_primary=true）
10. 準備物・タスクの一覧を閲覧
11. ステータスを更新・コメントを投稿

**追加の保護者（アクセスコード入力）**:

1. 保護者（例: 父）がLINE公式アカウントを友だち追加
2. リッチメニューからLIFFアプリを起動
3. LINE Loginで自動認証（LINE User ID取得）
4. 初回登録画面で「アクセスコード入力」を選択
5. 母から共有されたアクセスコードを入力
6. 自分と児童の関係を選択（父）
7. `line_accounts` に LINEアカウント情報を保存
8. `line_student_access` に紐づけを保存（is_primary=false）
9. 同じ生徒の情報にアクセス可能に

```
[データの流れ]
父のLINE ──┐
           ├── line_student_access ──→ 生徒（花子）
母のLINE ──┘                              ↓
                                    準備物・タスク
```

#### メッセージ応答フロー（Reply Token）

1. 保護者がLINE公式アカウントにメッセージ送信
1. Webhook経由でCloudflare Workersが受信
1. メッセージ内容を解析（キーワードマッチング）
1. Reply Tokenを使って即座に応答（無料）
1. 必要に応じてLIFFアプリへの導線を案内

#### 管理者の操作フロー

1. 管理者がWebブラウザから管理画面にアクセス
1. 情報を入力/更新
1. 必要に応じて翻訳を生成（Workers AI）
1. 翻訳結果をDBに保存
1. **緊急時のみ**手動でプッシュ通知を送信

---

## 12. 技術スタック

|レイヤー   |技術                        |
|-------|--------------------------|
|ホスティング |Cloudflare Workers        |
|データベース |Cloudflare D1 (SQLite)    |
|AI     |Cloudflare Workers AI (翻訳)|
|フロントエンド（管理者）|Hono + JSX または React      |
|フロントエンド（保護者）|LIFF（LINE Front-end Framework）|
|LINE Platform|LINE公式アカウント + LINE Login + Messaging API|
|認証     |LINE Login（保護者）、パスキー（LINE未使用者）、パスワード（管理者）|

### LINE Platform 構成詳細

| コンポーネント | 用途 |
|--------------|------|
| LINE公式アカウント | 保護者との接点、リッチメニュー、Webhook受信 |
| LIFF | LINE内で動作するWebアプリ（保護者向けUI） |
| LINE Login | LIFFアプリでの認証、LINE User ID取得 |
| Messaging API | Reply Token応答、手動プッシュ通知 |
