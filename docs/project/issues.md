# 設計課題

**作成日**: 2024年12月
**更新日**: 2025年12月

---

本セクションでは、実装に向けて詳細設計が必要な課題を整理する。

## 14.1 マルチテナント関連

### 14.1.1 テナントオンボーディング

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| テナント作成フロー | 新規テナントの申込→審査→作成→初期設定の一連のフロー | 高 |
| LINE公式アカウント連携 | テナントごとのLINE公式アカウント開設とシステム連携の手順 | 高 |
| 初期データ投入 | 教室・クラス・生徒情報の一括インポート方法 | 中 |
| 管理者招待 | テナントオーナーが他の管理者を招待する仕組み | 中 |

### 14.1.2 テナント分離の詳細

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| クエリフィルタの強制 | 全クエリに tenant_id フィルタを確実に適用するミドルウェア設計 | 高 |
| テナント越境検知 | 不正なテナント越境アクセスの検知と通知 | 高 |
| 共有リソースの扱い | システム共通テンプレート・用語辞書のアクセス制御 | 中 |
| データエクスポート | テナント単位でのデータエクスポート機能 | 低 |

### 14.1.3 課金・プラン管理

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| プラン定義 | free / basic / premium 各プランの機能制限の詳細 | 中 |
| 利用量計測 | 生徒数、管理者数、翻訳回数などの計測方法 | 中 |
| 請求処理 | 課金システムとの連携（Stripe等） | 低 |
| プラン変更 | アップグレード/ダウングレード時のデータ処理 | 低 |

## 14.2 認証・認可関連

### 14.2.1 LINE認証の詳細

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| 複数テナント所属 | 同一LINEユーザーが複数テナントに所属する場合のUI/UX | 高 |
| テナント切替 | 保護者が複数教室を利用する場合のテナント切替方法 | 高 |
| LIFF初回起動 | テナント未登録ユーザーのLIFF初回起動時のフロー | 高 |
| セッション管理 | テナントコンテキストを含むセッション管理方式 | 高 |

### 14.2.2 管理者認証

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| パスワードポリシー | パスワード強度要件、有効期限 | 中 |
| 二要素認証 | 管理者向け2FAの導入可否 | 低 |
| ログイン履歴 | 管理者ログイン履歴の保存と監査 | 中 |

## 14.3 データモデル関連

### 14.3.1 未定義の詳細

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| 教室マスタ | studio カラムの値をテナント設定で定義する仕組み | 高 |
| クラスマスタ | class_name の管理方法（マスタテーブル or 自由入力） | 中 |
| ステータス定義 | テナントごとにカスタマイズ可能なステータス定義の管理 | 中 |
| 削除ポリシー | 論理削除 vs 物理削除の方針、データ保持期間 | 中 |

### 14.3.2 マイグレーション

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| スキーマバージョン管理 | D1でのマイグレーション管理方法 | 高 |
| 後方互換性 | スキーマ変更時の既存データへの影響 | 高 |
| ロールバック | 問題発生時のロールバック手順 | 中 |

## 14.4 LINE連携関連

### 14.4.1 Webhook処理

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| 署名検証 | テナントごとのChannel Secretを使った署名検証 | 高 |
| リトライ対応 | LINE Webhook のリトライ時の冪等性確保 | 高 |
| エラー通知 | Webhook処理エラー時の管理者通知 | 中 |

### 14.4.2 LIFF設定

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| LIFF URLの構造 | テナントごとのLIFF URL設計（1 LIFF vs テナント別LIFF） | 高 |
| Endpoint URL | LIFF Endpoint URLの動的設定方法 | 高 |
| 権限スコープ | 必要なLINE Login権限スコープの整理 | 中 |

## 14.5 翻訳機能関連

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| 翻訳キャッシュ | 同一テキストの再翻訳を避けるキャッシュ戦略 | 中 |
| 翻訳品質監視 | 翻訳結果の品質確認と手動修正の仕組み | 低 |
| 用語辞書の共有 | システム共通辞書とテナント固有辞書のマージ方法 | 中 |
| コスト管理 | テナントごとの翻訳API使用量の計測と制限 | 中 |

## 14.6 運用・保守関連

### 14.6.1 監視・アラート

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| ヘルスチェック | システム正常性の監視方法 | 高 |
| エラー通知 | 重大エラー発生時の運用者への通知 | 高 |
| パフォーマンス監視 | レスポンスタイム、D1クエリ性能の監視 | 中 |

### 14.6.2 バックアップ・復旧

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| バックアップ戦略 | D1のバックアップ頻度と保持期間 | 高 |
| 障害復旧手順 | データ破損時の復旧手順 | 高 |
| テナント削除 | テナント解約時のデータ削除手順とアーカイブ | 中 |

## 14.7 セキュリティ関連

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| 機密情報の暗号化 | Channel Secret等の機密情報の保存方法 | 高 |
| アクセスコードの強度 | アクセスコード（例: ABC-1234）の衝突確率と強度 | 中 |
| レート制限 | API呼び出しのレート制限の実装 | 中 |
| CORS設定 | 許可するオリジンの管理方法 | 中 |

## 14.8 今後の拡張に向けた課題

| 課題 | 詳細 | 優先度 |
|------|------|--------|
| 複数言語追加 | 日英露以外の言語追加時の影響範囲 | 低 |
| 他プラットフォーム対応 | LINE以外（WhatsApp, WeChat等）への対応可能性 | 低 |
| ネイティブアプリ | 将来的なネイティブアプリ化の可能性と設計考慮 | 低 |
| 分析・レポート | 出欠統計、準備進捗レポート等の分析機能 | 低 |
