# セキュリティ設計

**作成日**: 2024年12月
**更新日**: 2025年12月

---

## 7.1 設計原則

子供のバレエ教室という性質上、**個人情報とプライバシーの保護**は最優先事項です。特に「いつ・誰が・どこにいるか」という情報は、悪意ある第三者に悪用される可能性があるため、厳重に管理します。

### 基本方針

- **最小権限の原則**: 各ユーザーは自分の役割に必要な情報のみにアクセス可能
- **明示的な同意**: 情報共有には明確な同意を取得
- **監査可能性**: すべてのアクセスと変更を記録
- **デフォルトで非公開**: 情報は明示的に許可されない限り非公開

## 7.2 役割と権限

### ユーザー役割の定義

| 役割 | 説明 | 権限レベル |
|------|------|-----------|
| 先生（owner） | 教室のオーナー | 全情報へのフルアクセス |
| 保護者代表（admin） | 運営を補助する保護者 | 生徒・レッスン情報の閲覧、連絡管理 |
| 一般保護者（guardian） | 通常の保護者 | 自分の子供に関する情報のみ |

### 情報アクセス権限マトリクス

| 情報種別 | 先生 | 保護者代表 | 一般保護者 |
|---------|------|-----------|-----------|
| 自分の子供の情報 | ✅ | ✅（担当生徒のみ） | ✅ |
| 全生徒の名簿 | ✅ | ✅ | ❌ |
| 他の生徒の出欠状況 | ✅ | ✅ | ❌ |
| レッスン参加者一覧 | ✅ | ✅ | ❌ |
| 臨時レッスン対象者一覧 | ✅ | ✅ | ❌（自分の子供が対象かのみ） |
| 全体の応答状況集計 | ✅ | ✅ | ❌ |
| 発表会キャスティング | ✅ | ✅ | ✅（公開設定されたもの） |

## 7.3 レッスン情報のプライバシー保護

### 臨時レッスンの情報公開制御

臨時レッスンは**対象となる生徒の保護者のみ**に通知されます。

```
[臨時レッスン: 発表会前特別練習]
├── 対象: 花子、桜子、太郎
│
├── 花子の保護者 → 「花子さんが対象の臨時レッスンがあります」✅
├── 桜子の保護者 → 「桜子さんが対象の臨時レッスンがあります」✅
├── 太郎の保護者 → 「太郎くんが対象の臨時レッスンがあります」✅
└── 他の生徒の保護者 → 通知なし、情報にアクセス不可 ❌
```

**設計ポイント**:
- 一般保護者は「誰が臨時レッスンに呼ばれたか」を知ることができない
- 自分の子供が対象かどうかのみ確認可能
- 参加/不参加の応答も本人のみ

### 通常レッスンの出欠情報

通常レッスンの出欠情報も、一般保護者には自分の子供の情報のみ表示。

```
[一般保護者が見る画面]
花子さんの出欠状況
├── 12/16（月）通常レッスン: 出席
├── 12/18（水）通常レッスン: 欠席
└── 12/20（金）臨時レッスン: 参加予定

※ 他の生徒の出欠状況は表示されません
```

```
[先生・保護者代表が見る画面]
12/16（月）通常レッスン 出席状況
├── 出席: 花子、桜子、太郎、...（15名）
├── 欠席: 美咲、健太（2名）
└── 未回答: なし
```

## 7.4 応答情報の集計とプライバシー

### 臨時レッスン応答の表示

| 閲覧者 | 表示される情報 |
|--------|---------------|
| 先生・保護者代表 | 参加者名一覧、不参加者名一覧、未回答者名一覧 |
| 一般保護者 | 自分の子供の応答状況のみ + 全体の集計数（例: 参加12名、不参加3名） |

**一般保護者への表示例**:
```
臨時レッスン: 発表会前特別練習
日時: 12/22（日）14:00-16:00

[花子さんの応答]
✅ 参加する

[全体の状況]
参加: 12名 / 不参加: 3名 / 未回答: 2名
（参加者名は表示されません）
```

### 休校確認の表示

| 閲覧者 | 表示される情報 |
|--------|---------------|
| 先生・保護者代表 | 確認済み保護者一覧、未確認保護者一覧 |
| 一般保護者 | 自分の確認状況のみ |

## 7.5 データアクセス制御の実装

### APIレベルでの制御

```
[APIエンドポイント設計]

GET /api/lessons/{id}/participants
├── 先生・保護者代表 → 全参加者リストを返却
└── 一般保護者 → 403 Forbidden（または自分の子供の情報のみ）

GET /api/lessons/{id}/responses
├── 先生・保護者代表 → 全応答リストを返却
└── 一般保護者 → 自分の子供の応答のみ返却

GET /api/lessons/{id}/summary
├── 全ユーザー → 集計情報のみ返却（参加X名、不参加Y名）
└── 個人を特定できる情報は含まない
```

### クエリレベルでの制御

```sql
-- 一般保護者向け: 自分の子供のレッスンイベントのみ取得
SELECT le.*
FROM lesson_events le
WHERE le.id IN (
  -- 教室全体対象のイベント（自分の子供の教室）
  SELECT le2.id FROM lesson_events le2
  JOIN students s ON le2.studio = s.studio
  JOIN line_student_access lsa ON s.id = lsa.student_id
  WHERE lsa.line_account_id = :current_user_id
    AND le2.target_type = 'all_studio'

  UNION

  -- 特定生徒対象のイベント（自分の子供が対象）
  SELECT le3.id FROM lesson_events le3
  JOIN lesson_event_targets let ON le3.id = let.lesson_event_id
  JOIN line_student_access lsa2 ON let.student_id = lsa2.student_id
  WHERE lsa2.line_account_id = :current_user_id
);
```

## 7.6 セキュリティ監査

### アクセスログの記録

すべての機密情報へのアクセスを記録し、不正アクセスを検知。

```sql
CREATE TABLE access_log (
  id TEXT PRIMARY KEY,
  line_account_id TEXT NOT NULL,
  resource_type TEXT NOT NULL, -- 'lesson_event', 'student', 'response', etc.
  resource_id TEXT NOT NULL,
  action TEXT NOT NULL, -- 'view', 'list', 'export'
  access_granted BOOLEAN NOT NULL, -- アクセスが許可されたか
  ip_address TEXT,
  user_agent TEXT,
  created_at TEXT NOT NULL,
  FOREIGN KEY (line_account_id) REFERENCES line_accounts(id)
);
```

### 異常検知

- 短時間での大量アクセス
- 権限外の情報へのアクセス試行
- 通常と異なるパターンのアクセス

## 7.7 通知におけるプライバシー配慮

### LINE通知の内容制限

通知メッセージには**最小限の情報のみ**を含め、詳細はLIFFアプリで確認する設計。

**良い例**:
```
📢 臨時レッスンのお知らせ
花子さん宛の臨時レッスンがあります。
詳細を確認 → [LIFFリンク]
```

**悪い例**（避けるべき）:
```
📢 臨時レッスンのお知らせ
12/22（日）14:00-16:00 ○○スタジオ
発表会前特別練習
対象: 花子、桜子、太郎、美咲、...
```

### 理由

- LINEメッセージはスマホのロック画面に表示される可能性
- 第三者に見られても個人の行動情報が漏れないように
- 詳細は認証済みのLIFFアプリ内でのみ表示
