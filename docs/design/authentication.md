# 認証設計

**作成日**: 2024年12月
**更新日**: 2025年12月

---

## 5.1 LINE認証（保護者向け）

LINE公式アカウント経由でLIFFアプリにアクセスする保護者は、LINE Loginにより自動的に認証される。

**特徴**

- LINE公式アカウントを友だち追加するだけで利用開始
- LIFFアプリ起動時にLINE User IDを自動取得
- パスキーの発行・管理が不要
- **複数の保護者（父・母・祖父母など）が同じ子供にアクセス可能**
- **アクセスコードによる柔軟な紐づけ**

**運用フロー（初回登録：最初の保護者）**

1. 管理者がLINE公式アカウントの友だち追加用QRコードを配布
2. 保護者（例: 母）がQRコードからLINE公式アカウントを友だち追加
3. 友だち追加時のウェルカムメッセージでLIFFアプリへの導線を案内
4. 保護者がLIFFアプリを起動、LINE Loginで自動認証
5. 初回アクセス時に児童情報を登録（児童名、教室、自分との関係）
6. システムが生徒ごとに**アクセスコード**を自動発行（例: `HNK-7842`）
7. LINE User IDと生徒が `line_student_access` テーブルで紐づけ

**運用フロー（追加登録：他の保護者）**

1. 最初の保護者が他の保護者（例: 父）にアクセスコードを共有
2. 父がLINE公式アカウントを友だち追加、LIFFアプリを起動
3. 「子供を追加」画面でアクセスコードを入力
4. 父のLINEアカウントが同じ生徒に紐づけられる（関係: 父）
5. 必要に応じて祖父母なども同様に追加可能

```
[紐づけの例]
母のLINE (is_primary=true) ─┬─ 長女（花子）access_code: HNK-7842
父のLINE                   ─┤
祖母のLINE                 ─┘

母のLINE (is_primary=true) ─┬─ 次女（桜子）access_code: SKR-3156
父のLINE                   ─┘
```

**スコープ**

- LINEアカウント単位で認証（1人の大人 = 1つのLINEアカウント）
- 1つのLINEアカウントで複数の生徒にアクセス可能（兄弟姉妹）
- 複数のLINEアカウントが同じ生徒にアクセス可能（父・母・祖父母）
- `is_primary` フラグで主担当を設定（通知の優先送信先）

**LINE未使用者への対応**

LINEを使用しない保護者向けに、従来のパスキー認証も併用可能。

- 形式: `ballet-sakura-7842` のような覚えやすい文字列
- Webブラウザから直接アクセス
- 管理者が個別に発行・配布
- 生徒との紐づけにはアクセスコードを使用

## 5.2 パスワード認証（管理者向け）

管理者はWebブラウザから従来のパスワード認証でアクセス。

**役割と権限**

|役割       |権限                             |
|---------|-------------------------------|
|先生（owner）|全データの閲覧・編集、演目・出演者の確定、手動プッシュ通知送信|
|サポート保護者  |情報の補足入力、問い合わせ対応、パスキー発行（LINE未使用者向け）|
|一般保護者    |自分の子供の情報閲覧、準備ステータスの更新、コメント投稿   |
