# 通知設計

**作成日**: 2024年12月
**更新日**: 2025年12月

---

## 10.1 基本方針

**プル型を基本とし、プッシュは最後の手段**

本システムでは、コスト削減と運用負荷軽減のため、**プル型（保護者が自ら情報を取得）** を基本とし、**プッシュ通知は緊急時のみ手動で送信** する設計とする。

| 通知方式 | 説明 | コスト |
|---------|------|--------|
| Reply Token応答 | 保護者がメッセージを送信した際に返信 | **無料** |
| プッシュ通知 | 管理者が手動で送信（緊急時のみ） | 有料（月200通まで無料） |

**設計思想**:

- 保護者は必要な時にLIFFアプリを開いて情報を確認（プル型）
- キーワードを送信すれば、Reply Tokenで最新情報を返信（無料）
- 緊急時のみ管理者が判断してプッシュ通知を送信

## 10.2 Reply Token応答（無料）

保護者がLINE公式アカウントにメッセージを送信した際、Reply Tokenを使って即座に応答。

### 応答パターン

**ステータス確認**

保護者: 「確認」
```
📋 お子様の準備状況

[花子さん]
✅ 衣装（白チュチュ）: 完了
⏳ 小道具（花冠）: 準備中
❌ リボン: 未着手

詳細はこちら → [LIFFリンク]
```

**未完了タスク一覧**

保護者: 「タスク」
```
📝 未完了のタスク

1. リボンの購入（12/20まで）
2. 靴のサイズ確認（12/22まで）

詳細・ステータス更新 → [LIFFリンク]
```

**最新のお知らせ**

保護者: 「お知らせ」
```
📢 最新のお知らせ

[12/15] 発表会の集合時間が変更になりました
[12/14] 衣装の最終確認について

詳細 → [LIFFリンク]
```

**レッスン予定確認**

保護者: 「レッスン」
```
📅 今後のレッスン予定

[花子さん]
12/18（水）16:00 通常レッスン
12/20（金）14:00 臨時レッスン ⚠️要回答
12/22（日）休校

詳細・応答 → [LIFFリンク]
```

**臨時レッスン応答**

保護者: 「臨時」
```
📢 要対応の臨時レッスン

[花子さん]
12/20（金）14:00 発表会前特別練習
締切: 12/18（水）まで
現在の回答: 未回答

応答する → [LIFFリンク]
```

**休校確認**

保護者: 「休校」
```
📢 休校のお知らせ

[花子さん]
12/22（日）台風接近のため休校
振替: 12/29（日）14:00

確認済みにする → [LIFFリンク]
```

## 10.3 手動プッシュ通知（最後の手段）

プッシュ通知は**緊急時のみ**管理者が手動で送信。自動送信は行わない。

**プッシュ通知を使用するケース**:

| ケース | 例 |
|--------|-----|
| 緊急の日程変更 | 「本日のリハーサルが中止になりました」 |
| 重要な締め切り直前 | 「衣装サイズ確認の締め切りが明日です」 |
| 全員への重要連絡 | 「発表会会場が変更になりました」 |
| 当日の休校連絡 | 「本日は台風のため休校です」 |
| 臨時レッスンの緊急追加 | 「明日、臨時レッスンを行います」 |

**プッシュ通知を使用しないケース**:

- 通常の情報更新（保護者がLIFFで確認）
- 定期的なリマインダー（保護者がキーワードで確認）
- 個別の質問への返信（Reply Tokenで応答）

### プッシュ通知の送信フロー

1. 管理者が管理画面で「手動プッシュ通知」を選択
2. 送信対象を選択（全員 / 教室別 / 発表会別 / 個人）
3. メッセージ内容を作成
4. 送信理由を記録（監査のため）
5. 確認画面で送信数とコストを確認
6. 送信実行

### プッシュ通知のテンプレート例

**緊急連絡**:
```
🚨 緊急のお知らせ

[内容]

詳細 → [LIFFリンク]
```

**リマインダー**:
```
⏰ リマインダー

[締め切り情報]

確認・更新 → [LIFFリンク]
```

**休校連絡**:
```
📢 休校のお知らせ

花子さんのレッスンについて
休校のお知らせがあります。

詳細を確認 → [LIFFリンク]
```

**臨時レッスン連絡**:
```
📢 臨時レッスンのお知らせ

花子さん宛の臨時レッスンがあります。
参加/不参加をお知らせください。

詳細・応答 → [LIFFリンク]
```

**注意**: プライバシー保護のため、通知メッセージには日時・場所・他の参加者などの詳細情報を含めません。詳細はLIFFアプリ内でのみ表示します。

## 10.4 アプリ内通知（LIFFアプリ）

LIFFアプリ内での通知表示。プッシュ通知なしでも更新を把握可能。

**未読管理**:

- マイページに未読件数をバッジ表示
- 「最後にアクセスしてからの変更」をハイライト
- 更新された項目に「NEW」マークを表示

**更新履歴の表示**:

- 自分に関連する変更の履歴
- 時系列での変更一覧
- フィルタリング（種類、期間）

## 10.5 通知の多言語化

応答メッセージは保護者の希望言語に応じて送信。

**日本語**:
```
📋 お子様の準備状況
✅ 衣装: 完了
詳細 → [リンク]
```

**英語**:
```
📋 Your child's preparation status
✅ Costume: Completed
Details → [link]
```

**ロシア語**:
```
📋 Статус подготовки вашего ребенка
✅ Костюм: Готов
Подробнее → [ссылка]
```

## 10.6 コスト比較

**従来のプッシュ通知方式**:

| 項目 | 月間通知数 | コスト |
|------|-----------|--------|
| 定期リマインダー | 100通 | 有料 |
| 更新通知 | 200通 | 有料 |
| 緊急通知 | 10通 | 有料 |
| **合計** | 310通 | 月額数百円〜 |

**本システム（Reply Token + 手動プッシュ）**:

| 項目 | 月間通知数 | コスト |
|------|-----------|--------|
| Reply Token応答 | 無制限 | **無料** |
| 手動プッシュ（緊急時のみ） | 〜50通 | 無料枠内 |
| **合計** | - | **月額0円** |
